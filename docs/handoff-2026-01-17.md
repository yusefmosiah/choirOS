# Handoff - 2026-01-17

## Context
Goal: close the event-loop walking skeleton. Canonical event contract + `file.write` path end-to-end, enable NATS in dev, wire frontend NATS subscription.

## What’s done
- Canonical event contract spec + constants
  - `docs/specs/CHOIR_EVENT_CONTRACT_SPEC.md`
  - `supervisor/event_contract.py`
  - `choiros/src/lib/event_contract.ts`
- NATS contract alignment (single `CHOIR` stream, subject format `choiros.{user_id}.{source}.{event_type}`, dot-delimited event types)
  - `supervisor/nats_client.py` uses `CHOIR` stream and `normalize_event_type`
  - `supervisor/db.py` normalizes types, uses `CHOIR` stream, replay filter updated
- `file.write` end-to-end logging
  - `supervisor/agent/tools.py` logs file writes via `EventStore.log_file_write_async`
  - `supervisor/agent/harness.py` passes event store into tools
  - `supervisor/main.py` passes store into harness
- Frontend NATS wiring
  - `choiros/src/App.tsx` connects to NATS and subscribes to `choiros.{user_id}.>`
  - `choiros/src/lib/nats.ts` uses canonical subject + type normalization
- Dev NATS enablement
  - `dev.sh` no longer sets `NATS_ENABLED=0`
  - `docker-compose.yml` uses `config/nats.conf` to expose WebSocket `8080`
- Fix JetStream stream config max_age units (seconds, not nanoseconds)
  - `supervisor/nats_client.py`
- Playwright E2E test for EventStream + NATS WS config
  - `choiros/playwright.config.ts`
  - `choiros/tests/e2e/eventstream.spec.ts`
  - `choiros/package.json`
  - `config/nats.conf`
- Fix `nats.ws` runtime import for type-only exports
  - `choiros/src/lib/nats.ts`
- Issues checklist updated
  - `docs/reviews/issues-jan-15.md` tasks 1–3 marked complete

## Tests
- Python smoke test: event contract helpers + SQLite `file.write`
  - Report: `docs/test_report-2026-01-17.md`
  - PASS
- NATS integration test: JetStream publish/subscribe for `file.write`
  - Report: `docs/test_report-2026-01-17.md`
  - PASS
- EventStream E2E (Playwright + NATS)
  - Report: `docs/test_report-2026-01-17.md`
  - PASS

## How to resume (now that Docker is running)
1) Start NATS:
   - `docker compose up -d nats`
2) Run an automated E2E check:
   - `cd choiros`
   - `npm run test:e2e`

Suggested quick manual check:
- Start supervisor:
  - `source api/venv/bin/activate`
  - `PYTHONPATH="$PWD" SUPERVISOR_STANDALONE=1 NATS_ENABLED=1 python -m supervisor.main`
- Publish a file write through agent or direct store call.
- Subscribe to NATS (e.g., `nats sub 'choiros.local.>'` if you have the CLI) and confirm subject `choiros.local.agent.file.write`.

## Next task
- Triage remaining critical issues in `docs/reviews/issues-jan-15.md` (CR-01/CR-02/CR-03/CR-04).

## Files changed
- `.gitignore`
- `choiros/src/App.tsx`
- `choiros/src/components/desktop/EventStream.css`
- `choiros/src/components/desktop/EventStream.tsx`
- `choiros/src/lib/nats.ts`
- `choiros/src/lib/event_contract.ts` (new)
- `choiros/src/stores/events.ts`
- `choiros/playwright.config.ts`
- `choiros/tests/e2e/eventstream.spec.ts`
- `choiros/package.json`
- `choiros/package-lock.json`
- `config/nats.conf`
- `dev.sh`
- `docker-compose.yml`
- `docs/reviews/issues-jan-15.md`
- `docs/specs/CHOIR_EVENT_CONTRACT_SPEC.md` (new)
- `docs/test_report-2026-01-17.md` (new)
- `docs/handoff-2026-01-17.md` (new)
- `supervisor/event_contract.py` (new)
- `supervisor/agent/harness.py`
- `supervisor/agent/tools.py`
- `supervisor/db.py`
- `supervisor/main.py`
- `supervisor/nats_client.py`

## Notes
- `api/venv` was created and dependencies installed to run tests.
- NATS integration and EventStream E2E tests now pass with Docker NATS + WS config.
