services:
  nats:
    image: nats:2.10-alpine
    command: -c /etc/nats/nats.conf
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # Monitoring UI
      - "8080:8080"   # WebSocket connections
    volumes:
      - ./config/nats.conf:/etc/nats/nats.conf:ro
      - nats-data:/data
    restart: unless-stopped

  choiros:
    build: .
    ports:
      - "5173:5173"
      - "8000:8000"
      - "8001:8001"
    volumes:
      # Mount source for live reloading during development
      - ./choiros/src:/app/choiros/src:rw
      - ./choiros/public:/app/choiros/public:rw
      - ./api:/app/api:rw
      - ./supervisor:/app/supervisor:rw
      # Persist artifacts
      - ./artifacts:/app/artifacts:rw
      # Persist logs
      - ./logs:/app/logs:rw
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
      - VITE_SUPERVISOR_URL=http://localhost:8001
      - NATS_USER=choiros_supervisor
      - NATS_PASSWORD=local_supervisor
      - NATS_URL=nats://nats:4222
      # AWS Bedrock credentials (from .env file)
      - AWS_BEARER_TOKEN_BEDROCK
      - AWS_REGION
    env_file:
      - api/.env
    depends_on:
      - nats
    # Restart on failure
    restart: unless-stopped

volumes:
  nats-data:
